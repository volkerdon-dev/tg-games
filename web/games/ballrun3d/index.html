<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Ball Run 3D</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{--bg:#f7faff;--text:#0b1220;--accent:#2ea6ff}
    html,body{margin:0;height:100%;overflow:hidden;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto;color:var(--text)}
    #ui{position:absolute;top:8px;left:8px;right:8px;display:flex;justify-content:space-between;align-items:center;z-index:10}
    a.back{text-decoration:none;background:#fff;border:1px solid #ccd3e0;border-radius:12px;padding:8px 12px;color:var(--text);font-size:14px}
    .score{background:rgba(255,255,255,.9);border-radius:12px;padding:8px 14px;font-size:16px;font-weight:600}
    #msg{position:absolute;inset:0;display:none;align-items:center;justify-content:center;flex-direction:column;gap:10px;background:rgba(0,0,0,.5);color:#fff;z-index:20;text-align:center;padding:16px}
    #msg button{padding:8px 14px;border:none;border-radius:12px;background:#2ea6ff;color:#000;font-weight:600}
    canvas{display:block;width:100%;height:100%}
  </style>
</head>
<body>
  <div id="ui">
    <a class="back" href="../../index.html">← В меню игр</a>
    <div class="score">Очки: <span id="score">0</span></div>
  </div>
  <div id="msg">
    <div id="msgText">Не удалось запустить WebGL/Three.js.</div>
    <button onclick="location.reload()">Перезагрузить</button>
  </div>

  <!-- Модульная загрузка Three.js с фолбэком -->
  <script type="module">
    const tg = window.Telegram?.WebApp; tg?.ready(); tg?.expand();

    async function loadThree(){
      const urls=[
        'https://unpkg.com/three@0.165.0/build/three.module.js',
        'https://cdn.jsdelivr.net/npm/three@0.165.0/build/three.module.js'
      ];
      for(const u of urls){
        try{ return await import(u); }catch(e){}
      }
      throw new Error('THREE not loaded');
    }
    function showError(text){
      const b=document.getElementById('msg');
      document.getElementById('msgText').textContent=text; b.style.display='flex';
    }

    let THREE;
    try{ THREE=await loadThree(); }catch(e){ showError('Не удалось загрузить движок (Three.js).'); throw e; }

    // Сцена/камера/рендер
    const scene=new THREE.Scene();
    let renderer;
    try{
      renderer=new THREE.WebGLRenderer({antialias:true, powerPreference:'high-performance'});
      renderer.setSize(innerWidth, innerHeight);
      renderer.setClearColor(0xf7faff,1);
      document.body.appendChild(renderer.domElement);
    }catch(e){ showError('WebGL недоступен в этом окружении.'); throw e; }

    const camera=new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 1000);

    // Свет
    const dir=new THREE.DirectionalLight(0xffffff,1); dir.position.set(4,6,6); scene.add(dir);
    scene.add(new THREE.AmbientLight(0xffffff,0.45));

    // «Дорога»: длинная полоса слева→направо, узкая по вертикали
    const ROAD_LEN=800;
    const roadGeom=new THREE.BoxGeometry(ROAD_LEN, 0.2, 10);
    const roadMat =new THREE.MeshPhongMaterial({color:0xe9edf8});
    const road=new THREE.Mesh(roadGeom, roadMat);
    road.position.set(ROAD_LEN/2, -1, 0); // начинается с x=0, идёт вправо
    scene.add(road);

    // Шар — КРАСНЫЙ
    const ball=new THREE.Mesh(
      new THREE.SphereGeometry(0.6,32,32),
      new THREE.MeshPhongMaterial({color:0xff3b30, shininess:90})
    );
    ball.position.set(0,-0.4,0);
    scene.add(ball);

    // Камера смотрит вдоль оси X (слева→направо), игрок управляет по Z (вверх/вниз на экране)
    camera.position.set(ball.position.x - 5, 3.2, 9);
    camera.lookAt(ball.position.x + 6, 0, 0);

    // Препятствия — кубы разных цветов, спавнятся впереди (справа) и движутся относительно шара
    const obstacles=[];
    function spawnObstacle(x){
      const height = 1 + Math.random()*1.2;
      const width  = 1 + Math.random()*1.5;
      const z = (Math.random()-0.5)*8; // по вертикали (экрана)
      const color = new THREE.Color().setHSL(Math.random(), 0.65, 0.55);
      const m = new THREE.MeshPhongMaterial({color});
      const g = new THREE.BoxGeometry(width, height, 1.2);
      const o = new THREE.Mesh(g, m);
      o.position.set(x, height/2 - 1, z);
      scene.add(o); obstacles.push(o);
    }
    for(let x=12; x<ROAD_LEN; x+=12){ spawnObstacle(x); }

    // Управление
    let targetZ=0, moveZ=0;
    let xSpeed=0.10;           // стартовая горизонтальная скорость (слева→направо)
    let alive=true, score=0;
    const scoreEl=document.getElementById('score');

    // свайпы ↑/↓ — двигаем по вертикали
    let tStart=null;
    addEventListener('touchstart',e=>{const t=e.touches[0]; tStart={x:t.clientX,y:t.clientY};},{passive:true});
    addEventListener('touchmove', e=>{
      if(!tStart) return;
      const t=e.touches[0];
      const dy=t.clientY - tStart.y;
      targetZ = THREE.MathUtils.clamp(-dy/60, -4, 4); // вверх отрицательный dy
    },{passive:true});
    addEventListener('touchend', ()=>{ tStart=null; },{passive:true});

    // клавиатура
    addEventListener('keydown', e=>{
      if(e.code==='ArrowUp')   targetZ -= 1;
      if(e.code==='ArrowDown') targetZ += 1;
      if(e.code==='ArrowRight') xSpeed += 0.02;      // ручное ускорение
      if(e.code==='ArrowLeft')  xSpeed = Math.max(0.06, xSpeed - 0.02);
    });

    // ресайз
    addEventListener('resize', ()=>{
      camera.aspect=innerWidth/innerHeight; camera.updateProjectionMatrix();
      renderer.setSize(innerWidth, innerHeight);
    });

    // столкновения
    function checkCollisions(){
      for(const o of obstacles){
        const dx=Math.abs(ball.position.x - o.position.x);
        const dz=Math.abs(ball.position.z - o.position.z);
        if(dx<1 && dz<1 && Math.abs(o.position.y - ball.position.y) < 1){
          alive=false; showGameOver(); return;
        }
      }
    }
    function showGameOver(){
      const box=document.getElementById('msg');
      document.getElementById('msgText').innerHTML=`Игра окончена<br>Очки: ${Math.floor(score)}`;
      box.style.display='flex';
    }

    // главный цикл
    function animate(){
      requestAnimationFrame(animate);
      if(alive){
        // движение слева→направо
        ball.position.x += xSpeed;
        // сглаженное движение по вертикали (ось Z)
        moveZ += (targetZ - moveZ) * 0.12;
        ball.position.z = moveZ * 2.5;

        // камера следует
        camera.position.x = ball.position.x - 5;
        camera.position.z = 9 + ball.position.z*0.1;
        camera.lookAt(ball.position.x + 6, 0, 0);

        // очки по дистанции + постепенное ускорение
        score += xSpeed * 50;
        xSpeed = Math.min(0.6, xSpeed + 0.00015);
        scoreEl.textContent = Math.floor(score);

        checkCollisions();

        // если вышли за пределы дороги — проигрыш
        if(Math.abs(ball.position.z) > 4.9 || ball.position.x > ROAD_LEN-2){
          alive=false; showGameOver();
        }
      }
      renderer.render(scene,camera);
    }
    animate();
  </script>
</body>
</html>
