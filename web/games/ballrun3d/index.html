<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Ball Run 3D</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{--bg:#f7faff;--text:#0b1220;--hint:#6b7280;--accent:#2ea6ff}
    html,body{margin:0;height:100%;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto;color:var(--text);overflow:hidden}
    #ui{position:absolute;top:8px;left:8px;right:8px;display:flex;justify-content:space-between;align-items:center;z-index:10}
    a.back{text-decoration:none;background:#fff;border:1px solid #ccd3e0;border-radius:12px;padding:8px 12px;color:var(--text);font-size:14px}
    .score{background:rgba(255,255,255,.9);border-radius:12px;padding:8px 14px;font-size:16px;font-weight:600}
    #msg{position:absolute;inset:0;display:none;align-items:center;justify-content:center;flex-direction:column;gap:10px;background:rgba(0,0,0,.5);color:#fff;z-index:20;text-align:center;padding:16px}
    #msg button{padding:8px 14px;border:none;border-radius:12px;background:#2ea6ff;color:#000;font-weight:600}
    canvas{display:block;width:100%;height:100%}
  </style>
</head>
<body>
  <div id="ui">
    <a class="back" href="../../index.html">← В меню игр</a>
    <div class="score">Очки: <span id="score">0</span></div>
  </div>
  <div id="msg">
    <div id="msgText">Не удалось запустить WebGL/Three.js.</div>
    <button onclick="location.reload()">Перезагрузить</button>
  </div>

  <!-- ВАЖНО: модульный код с запасными CDN -->
  <script type="module">
    const tg = window.Telegram?.WebApp; tg?.ready(); tg?.expand();

    // ---------- Загрузка Three.js с резервом ----------
    async function loadThree() {
      const cdns = [
        'https://unpkg.com/three@0.165.0/build/three.module.js',
        'https://cdn.jsdelivr.net/npm/three@0.165.0/build/three.module.js',
      ];
      let THREE = null, lastErr = null;
      for (const url of cdns) {
        try { THREE = await import(url); break; }
        catch (e) { lastErr = e; }
      }
      if (!THREE) throw lastErr || new Error('THREE not loaded');
      return THREE;
    }

    function showError(text) {
      const box = document.getElementById('msg');
      document.getElementById('msgText').textContent = text;
      box.style.display = 'flex';
    }

    let THREE;
    try { THREE = await loadThree(); }
    catch (e) { showError('Не удалось загрузить движок (Three.js). Открой в браузере или попробуй позже.'); throw e; }

    // ---------- Инициализация сцены ----------
    let renderer, camera, scene;
    try {
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
      renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: 'high-performance' });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setClearColor(0xf7faff, 1);
      document.body.appendChild(renderer.domElement);
    } catch (e) {
      showError('WebGL не поддерживается в этом веб-просмотрщике.');
      throw e;
    }

    // Градиентное «небо»
    const bg = new THREE.Color(0xf7faff);
    scene.background = bg;

    // Свет
    const dir = new THREE.DirectionalLight(0xffffff, 1.0);
    dir.position.set(2,4,5);
    scene.add(dir);
    scene.add(new THREE.AmbientLight(0xffffff, 0.45));

    // Дорога
    const roadGeom = new THREE.BoxGeometry(10, 0.2, 400);
    const roadMat  = new THREE.MeshPhongMaterial({ color: 0xe9edf8 });
    const road = new THREE.Mesh(roadGeom, roadMat);
    road.position.set(0, -1, -200);      // тянется от z=0 до z=-400
    scene.add(road);

    // Шар
    const ballGeom = new THREE.SphereGeometry(0.5, 32, 32);
    const ballMat  = new THREE.MeshPhongMaterial({ color: 0x2ea6ff, shininess: 80 });
    const ball = new THREE.Mesh(ballGeom, ballMat);
    ball.position.set(0, -0.5, 0);
    scene.add(ball);

    // Препятствия
    const obstacles = [];
    function spawnObstacle(z) {
      const w = 1 + Math.random()*1.5;
      const h = 1 + Math.random();
      const x = (Math.random() - 0.5) * 6.5;
      const color = new THREE.Color().setHSL(Math.random(), 0.65, 0.55);
      const mat = new THREE.MeshPhongMaterial({ color });
      const g = new THREE.BoxGeometry(w, h, 1);
      const m = new THREE.Mesh(g, mat);
      m.position.set(x, h/2 - 1, -z);
      scene.add(m);
      obstacles.push(m);
    }
    for (let i = 10; i < 420; i += 15) spawnObstacle(i);

    // Камера
    camera.position.set(0, 2.8, 6);
    camera.lookAt(ball.position);

    // Управление
    let targetX = 0, moveX = 0;
    let zSpeed = 0.6;
    let alive = true;
    let score = 0;
    const scoreEl = document.getElementById('score');

    // свайпы
    let touchStart = null;
    window.addEventListener('touchstart', (e)=>{
      const t = e.touches[0];
      touchStart = {x:t.clientX, y:t.clientY};
    }, {passive:true});
    window.addEventListener('touchmove', (e)=>{
      if (!touchStart) return;
      const t = e.touches[0];
      const dx = t.clientX - touchStart.x;
      targetX = THREE.MathUtils.clamp(dx / 100, -4, 4);
    }, {passive:true});
    window.addEventListener('touchend', ()=>{ touchStart=null; }, {passive:true});

    // клавиатура
    window.addEventListener('keydown', (e)=>{
      if(e.code==='ArrowLeft')  targetX -= 1;
      if(e.code==='ArrowRight') targetX += 1;
      if(e.code==='ArrowUp')    zSpeed += 0.1;
      if(e.code==='ArrowDown')  zSpeed = Math.max(0.3, zSpeed - 0.1);
    });

    // ресайз
    window.addEventListener('resize', ()=>{
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // столкновения
    function checkCollisions() {
      for (const o of obstacles) {
        const dz = Math.abs(ball.position.z - o.position.z);
        const dx = Math.abs(ball.position.x - o.position.x);
        if (dz < 1 && dx < 1 && Math.abs(o.position.y - ball.position.y) < 1) {
          alive = false;
          showGameOver();
          return;
        }
      }
    }

    function showGameOver(){
      const box = document.getElementById('msg');
      document.getElementById('msgText').innerHTML = `Игра окончена<br>Очки: ${Math.floor(score)}`;
      box.style.display = 'flex';
    }

    // цикл
    function animate(){
      requestAnimationFrame(animate);
      if (alive) {
        ball.position.z -= zSpeed;
        moveX += (targetX - moveX) * 0.1;
        ball.position.x = moveX * 2;

        camera.position.z = ball.position.z + 6;
        camera.position.x = ball.position.x * 0.6;
        camera.lookAt(ball.position.x, 0, ball.position.z - 6);

        score += zSpeed * 0.5;
        scoreEl.textContent = Math.floor(score);

        checkCollisions();
      }
      renderer.render(scene, camera);
    }
    animate();
  </script>
</body>
</html>
