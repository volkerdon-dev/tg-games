<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Chess</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- Правила шахмат (MIT) -->
  <script src="https://cdn.jsdelivr.net/npm/chess.js@1/dist/chess.min.js"></script>

  <style>
    :root{
      --bg:#0f0f12; --text:#f3f6ff; --muted:#9aa3b2;
      --board-light:#f0d9b5; --board-dark:#b58863;
      --accent:#4e9eff; --panel:#171a22; --square:52px;
    }
    @media (max-width:420px){ :root{ --square:56px; } }
    *{ box-sizing:border-box; }
    body{ margin:0; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; }
    header{ padding:12px 14px; position:sticky; top:0; z-index:5; background:linear-gradient(180deg,#0f0f12 70%,transparent); }
    h1{ margin:0; font-size:18px; }
    .wrap{ max-width:980px; margin:0 auto; padding:12px; display:grid; gap:12px; grid-template-columns: 1fr; }
    @media (min-width:900px){ .wrap{ grid-template-columns: 480px 1fr; align-items:start; } }

    .panel{ background:var(--panel); border-radius:14px; padding:12px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    select,button{ border:0; border-radius:12px; padding:10px 12px; font-weight:600; }
    button.primary{ background:var(--accent); color:#fff; }
    .muted{ color:var(--muted); }

    .board{
      width:calc(var(--square) * 8); height:calc(var(--square) * 8);
      display:grid; grid-template-columns:repeat(8,1fr);
      border-radius:12px; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,.35);
      background:var(--board-light);
    }
    .sq{
      width:var(--square); height:var(--square);
      display:flex; align-items:center; justify-content:center;
      font-size:calc(var(--square) * .72); line-height:1;
      user-select:none; cursor:pointer; position:relative;
      outline:1px solid rgba(0,0,0,.06); outline-offset:-1px;
    }
    /* повышенная специфичность + !important от конфликта с внешними стилями */
    .sq.light{ background:var(--board-light) !important; }
    .sq.dark { background:var(--board-dark)  !important; }

    .sq.sel::after{ content:""; position:absolute; inset:4px; border:3px solid #2b8cff; border-radius:8px; }
    .sq.mv::before{ content:""; position:absolute; width:14px; height:14px; background:rgba(20,80,180,.55); border-radius:50%; }
    .sq.cap::before{ content:""; position:absolute; width:calc(var(--square) - 8px); height:calc(var(--square) - 8px); border:3px solid rgba(220,40,40,.75); border-radius:8px; }

    .info{ background:var(--panel); border-radius:14px; padding:12px; }
    .row{ display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
    .tag{ background:#23283a; color:#fff; padding:6px 10px; border-radius:10px; font-size:12px; }
    .log{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#10131a; color:#e6ecff; border-radius:10px; padding:8px; max-height:220px; overflow:auto; font-size:12px; white-space:pre-wrap; }
  </style>
</head>
<body>
<header>
  <h1>♟️ Chess</h1>
  <div class="muted" style="font-size:12px">Игра против встроенного ИИ. Unicode-фигуры • chess.js (MIT).</div>
</header>

<main class="wrap">
  <section><div id="board" class="board"></div></section>

  <section>
    <div class="panel">
      <label>Цвет:</label>
      <select id="color"><option value="w">Белые</option><option value="b">Чёрные</option></select>

      <label>Сложность:</label>
      <select id="difficulty" title="уровень ИИ">
        <option value="newbie">Новичок</option>
        <option value="casual" selected>Любитель</option>
        <option value="club">Клубный игрок</option>
        <option value="master">Мастер</option>
        <option value="supergm">Супер-гроссмейстер</option>
      </select>

      <button id="newgame" class="primary">Новая партия</button>
      <button id="flip">Повернуть доску</button>
    </div>

    <div class="info">
      <div class="row">
        <span class="tag" id="turn">Ход белых</span>
        <span class="tag" id="status">Игра идёт</span>
        <span class="tag" id="engine">ИИ: встроенный</span>
      </div>
      <h3 style="margin:12px 0 6px;font-size:14px">Журнал ходов (PGN)</h3>
      <div id="log" class="log"></div>
      <p class="muted" style="margin-top:10px">
        Лицензии: chess.js — MIT. Фигуры — стандарт Unicode.
      </p>
    </div>
  </section>
</main>

<script>
(() => {
  try { Telegram?.WebApp?.ready(); Telegram?.WebApp?.expand(); } catch(e){}

  const boardEl = document.getElementById('board');
  const turnTag = document.getElementById('turn');
  const statusTag = document.getElementById('status');
  const logEl = document.getElementById('log');
  const colorSel = document.getElementById('color');
  const diffSel  = document.getElementById('difficulty');

  // 1) Рендер клеток (с повышенной специфичностью классов)
  function renderBoard(){
    boardEl.innerHTML='';
    for(let r=0;r<8;r++){
      for(let c=0;c<8;c++){
        const d=document.createElement('div');
        d.className='sq ' + ((r+c)%2? 'dark':'light');
        d.dataset.r=r; d.dataset.c=c;
        boardEl.appendChild(d);
      }
    }
  }

  // 2) Игра и фигуры
  const GLYPH={'p':'♟','n':'♞','b':'♝','r':'♜','q':'♛','k':'♚','P':'♙','N':'♘','B':'♗','R':'♖','Q':'♕','K':'♔'};
  let game=new Chess(), flipped=false;

  const LVL={
    newbie:{depth:1, noise:60, think:150},
    casual:{depth:2, noise:35, think:200},
    club:{depth:3, noise:15, think:300},
    master:{depth:4, noise:5,  think:450},
    supergm:{depth:5, noise:0,  think:600},
  };

  const alg=(r,c)=>'abcdefgh'[c]+(8-r);
  const rc =(sq)=>({r:8-parseInt(sq[1],10), c:'abcdefgh'.indexOf(sq[0])});

  function paintPieces(){
    const pos=game.board(); const cells=boardEl.querySelectorAll('.sq');
    cells.forEach(c=>{ c.innerHTML=''; c.classList.remove('sel','mv','cap'); });
    for(let r=0;r<8;r++)for(let c=0;c<8;c++){
      const cell=pos[r][c]; if(!cell) continue;
      const span=document.createElement('span');
      span.style.fontFamily="'Segoe UI Symbol','Noto Sans Symbols2','Symbola','Arial Unicode MS',ui-sans-serif,sans-serif";
      span.textContent=GLYPH[cell.color==='w'?cell.type.toUpperCase():cell.type];
      span.style.color = cell.color==='w' ? '#fff' : '#111';
      span.style.textShadow = cell.color==='w' ? '0 1px 0 rgba(0,0,0,.35)' : '0 1px 0 rgba(255,255,255,.15)';
      cells[r*8+c].appendChild(span);
    }
  }

  function setStatus(){
    if(game.isGameOver()){
      if(game.isCheckmate()){
        const winner=game.turn()==='w'?'Чёрные':'Белые';
        statusTag.textContent='Мат — победили '+winner;
      }else if(game.isDraw()){
        statusTag.textContent='Ничья';
      }else{
        statusTag.textContent='Игра окончена';
      }
    }else if(game.inCheck()){
      statusTag.textContent='Шах';
    }else{
      statusTag.textContent='Игра идёт';
    }
    turnTag.textContent=game.turn()==='w'?'Ход белых':'Ход чёрных';
    logEl.textContent=game.pgn({max_width:50,newline_char:'\n'});
  }

  // 3) Встроенный ИИ (без воркеров): negamax + alpha-beta + материал
  const VAL = {p:100,n:320,b:330,r:500,q:900,k:0};
  function evaluate(ch){ // положительное — за белых
    let s=0, b=ch.board();
    for(let r=0;r<8;r++)for(let c=0;c<8;c++){
      const cell=b[r][c]; if(!cell) continue;
      const v = VAL[cell.type] || 0;
      s += (cell.color==='w'? v : -v);
    }
    // лёгкий бонус за мобильность
    const wm = ch.moves({legal:true}).length;
    ch.turn() === 'w' ? s += wm : s -= wm;
    return s;
  }

  function orderMoves(ch){ // захваты вперёд
    const ms = ch.moves({verbose:true});
    return ms.sort((a,b)=> (b.flags.includes('c')?1:0)-(a.flags.includes('c')?1:0));
  }

  function negamax(ch, depth, alpha, beta){
    if (depth===0 || ch.isGameOver()){
      const sc = evaluate(ch);
      return ch.turn()==='w'? sc : -sc;
    }
    let best=-Infinity;
    const moves = orderMoves(ch);
    for(const m of moves){
      ch.move(m);
      const score = -negamax(ch, depth-1, -beta, -alpha);
      ch.undo();
      if(score>best) best=score;
      if(best>alpha) alpha=best;
      if(alpha>=beta) break;
    }
    return best;
  }

  function pickMove(level){
    const opts = LVL[level]||LVL.casual;
    const moves = orderMoves(game);
    // оцениваем каждый ход
    let scored = moves.map(m=>{
      game.move(m);
      const sc = -negamax(game, opts.depth-1, -1e9, 1e9);
      game.undo();
      return {m, sc};
    });
    // шум для низких уровней
    if (opts.noise>0){
      scored.forEach(x=> x.sc += (Math.random()*2-1)*opts.noise);
    }
    scored.sort((a,b)=> b.sc - a.sc);
    return scored[0]?.m || moves[0];
  }

  function aiMove(){
    if(game.isGameOver()) return;
    const level = diffSel.value;
    const move = pickMove(level);
    setTimeout(()=>{
      if(move){ game.move(move); paintPieces(); setStatus(); }
    }, LVL[level]?.think || 250);
  }

  // 4) Интерактив
  let sel=null;
  function hi(from){
    const leg=game.moves({square:from,verbose:true}); const cells=boardEl.querySelectorAll('.sq');
    cells.forEach(c=>c.classList.remove('mv','cap'));
    for(const m of leg){ const {r,c}=rc(m.to); cells[r*8+c].classList.add(m.flags.includes('c')?'cap':'mv'); }
  }
  function onSquareClick(e){
    const el=e.currentTarget; const r=+el.dataset.r, c=+el.dataset.c;
    const rr=flipped?7-r:r, cc=flipped?7-c:c; const a=alg(rr,cc); const cells=boardEl.querySelectorAll('.sq');
    if(!sel){
      const p=game.get(a); if(!p || p.color!==game.turn()) return;
      sel=a; cells.forEach(x=>x.classList.remove('sel','mv','cap')); el.classList.add('sel'); hi(sel);
    }else{
      const mv=game.move({from:sel,to:a,promotion:'q'});
      if(mv){ sel=null; paintPieces(); setStatus(); if(!game.isGameOver()) aiMove(); }
      else { const p=game.get(a);
        if(p && p.color===game.turn()){ sel=a; cells.forEach(x=>x.classList.remove('sel','mv','cap')); el.classList.add('sel'); hi(sel); }
        else { sel=null; cells.forEach(x=>x.classList.remove('sel','mv','cap')); } }
    }
  }
  function attach(){ [...boardEl.querySelectorAll('.sq')].forEach(el=>el.addEventListener('click',onSquareClick)); }

  function orient(color){
    flipped=(color==='b');
    boardEl.style.transform=flipped?'rotate(180deg)':'none';
    [...boardEl.querySelectorAll('.sq')].forEach(el=> el.style.transform=flipped?'rotate(180deg)':'none');
  }

  function start(){
    renderBoard(); attach();
    game=new Chess(); paintPieces(); setStatus();
    orient(colorSel.value);
    if(colorSel.value==='b') aiMove(); // ИИ за белых, если игрок выбрал чёрных
  }

  document.getElementById('newgame').addEventListener('click', start);
  document.getElementById('flip').addEventListener('click', ()=> orient(flipped?'w':'b'));
  start();
})();
</script>
</body>
</html>
