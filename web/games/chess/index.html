<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Chess</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chess.js@1/dist/chess.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stockfish@16.1.0/stockfish.js"></script>

  <style>
    :root{
      --bg:#0f0f12; --text:#f3f6ff; --muted:#9aa3b2;
      --board-light:#f0d9b5; --board-dark:#b58863;
      --accent:#4e9eff; --panel:#171a22;
      --square:52px;
    }
    @media (max-width:420px){ :root{ --square:56px; } }
    *{ box-sizing:border-box; }
    body{ margin:0; background:var(--bg); color:var(--text); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto; }
    header{ padding:12px 14px; position:sticky; top:0; z-index:5; background:linear-gradient(180deg,#0f0f12 70%,transparent); }
    h1{ margin:0; font-size:18px; }
    .wrap{ max-width:980px; margin:0 auto; padding:12px; display:grid; gap:12px; grid-template-columns: 1fr; }
    @media (min-width:900px){ .wrap{ grid-template-columns: 480px 1fr; align-items:start; } }

    .panel{ background:var(--panel); border-radius:14px; padding:12px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    select,button{ border:0; border-radius:12px; padding:10px 12px; font-weight:600; }
    button.primary{ background:var(--accent); color:#fff; }
    .muted{ color:var(--muted); }

    .board{
      width:calc(var(--square) * 8);
      height:calc(var(--square) * 8);
      display:grid;
      grid-template-columns:repeat(8,1fr);
      border-radius:12px; overflow:hidden;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      background:var(--board-light);
    }
    .sq{
      width:var(--square); height:var(--square);
      display:flex; align-items:center; justify-content:center;
      font-size:calc(var(--square) * .72); line-height:1;
      user-select:none; cursor:pointer; position:relative;
      outline:1px solid rgba(0,0,0,.06); outline-offset:-1px;
    }
    .light{ background:var(--board-light); }
    .dark { background:var(--board-dark); }
    .sq.sel::after{ content:""; position:absolute; inset:4px; border:3px solid #2b8cff; border-radius:8px; }
    .sq.mv::before{ content:""; position:absolute; width:14px; height:14px; background:rgba(20,80,180,.55); border-radius:50%; }
    .sq.cap::before{ content:""; position:absolute; width:calc(var(--square) - 8px); height:calc(var(--square) - 8px); border:3px solid rgba(220,40,40,.75); border-radius:8px; }

    .info{ background:var(--panel); border-radius:14px; padding:12px; }
    .row{ display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
    .tag{ background:#23283a; color:#fff; padding:6px 10px; border-radius:10px; font-size:12px; }
    .log{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#10131a; color:#e6ecff; border-radius:10px; padding:8px; max-height:220px; overflow:auto; font-size:12px; white-space:pre-wrap; }
  </style>
</head>
<body>
<header>
  <h1>♟️ Chess</h1>
  <div class="muted" style="font-size:12px">Играй против ИИ Stockfish. Unicode-фигуры • Никаких сторонних ассетов.</div>
</header>

<main class="wrap">
  <section>
    <div id="board" class="board"></div>
  </section>

  <section>
    <div class="panel">
      <label>Цвет:</label>
      <select id="color">
        <option value="w">Белые</option>
        <option value="b">Чёрные</option>
      </select>

      <label>Сложность:</label>
      <select id="difficulty">
        <option value="newbie">Новичок</option>
        <option value="casual" selected>Любитель</option>
        <option value="club">Клубный игрок</option>
        <option value="master">Мастер</option>
        <option value="supergm">Супер-гроссмейстер</option>
      </select>

      <button id="newgame" class="primary">Новая партия</button>
      <button id="flip">Повернуть доску</button>
    </div>

    <div class="info">
      <div class="row">
        <span class="tag" id="turn">Ход белых</span>
        <span class="tag" id="status">Игра идёт</span>
        <span class="tag" id="engine">ИИ: —</span>
      </div>
      <h3 style="margin:12px 0 6px;font-size:14px">Журнал ходов (PGN)</h3>
      <div id="log" class="log"></div>
      <p class="muted" style="margin-top:10px">
        Stockfish © GPLv3 (веб-сборка). Правила — chess.js (MIT). Unicode-фигуры — стандарт Unicode.
      </p>
    </div>
  </section>
</main>

<script>
(() => {
  try { Telegram?.WebApp?.ready(); Telegram?.WebApp?.expand(); } catch(e){}

  const boardEl = document.getElementById('board');
  const turnTag = document.getElementById('turn');
  const statusTag = document.getElementById('status');
  const engineTag = document.getElementById('engine');
  const logEl = document.getElementById('log');
  const colorSel = document.getElementById('color');
  const diffSel  = document.getElementById('difficulty');

  // Рисование доски
  function renderBoard() {
    boardEl.innerHTML = '';
    for (let r=0;r<8;r++){
      for (let c=0;c<8;c++){
        const isDark = (r+c)%2===1;
        const d = document.createElement('div');
        d.className = 'sq ' + (isDark?'dark':'light');
        d.dataset.r=r; d.dataset.c=c;
        boardEl.appendChild(d);
      }
    }
  }

  const PIECE = {'p':'♟','n':'♞','b':'♝','r':'♜','q':'♛','k':'♚','P':'♙','N':'♘','B':'♗','R':'♖','Q':'♕','K':'♔'};
  let game = new Chess();
  let engine = null;
  let flipped = false;

  const LEVELS = {
    newbie:{skill:1,depth:6,movetime:300},
    casual:{skill:5,depth:10,movetime:400},
    club:{skill:10,depth:14,movetime:600},
    master:{skill:15,depth:18,movetime:900},
    supergm:{skill:20,depth:22,movetime:1200},
  };

  const algebraicFromRC = (r,c)=> 'abcdefgh'[c] + (8-r);
  const RCFromAlg = (sq)=> ({r:8-parseInt(sq[1],10), c:'abcdefgh'.indexOf(sq[0])});

  function paintPieces(){
    const pos = game.board();
    const squares = boardEl.querySelectorAll('.sq');
    squares.forEach(sq=>{ sq.textContent=''; sq.classList.remove('sel','mv','cap'); });
    for(let r=0;r<8;r++)for(let c=0;c<8;c++){
      const cell = pos[r][c];
      if(!cell) continue;
      const idx = r*8+c;
      squares[idx].textContent = PIECE[(cell.color==='w'?cell.type.toUpperCase():cell.type)];
    }
  }

  function setStatus(){
    if (game.isGameOver()){
      if (game.isCheckmate()){
        const winner = game.turn()==='w'?'Чёрные':'Белые';
        statusTag.textContent = 'Мат — победили '+winner;
      }else if (game.isDraw()){
        statusTag.textContent = 'Ничья';
      }else{
        statusTag.textContent = 'Игра окончена';
      }
    } else if (game.inCheck()){
      statusTag.textContent = 'Шах';
    } else {
      statusTag.textContent = 'Игра идёт';
    }
    turnTag.textContent = game.turn()==='w'?'Ход белых':'Ход чёрных';
    logEl.textContent = game.pgn({max_width:50,newline_char:'\n'});
  }

  // Безопасная инициализация движка
  function setupEngine(){
    engine = null;
    try {
      const E = Stockfish(); // может бросить в некоторых WebView
      engine = E;
      engineTag.textContent = 'ИИ: Stockfish';
      const opts = LEVELS[diffSel.value]||LEVELS.supergm;
      engine.postMessage('uci');
      engine.postMessage('setoption name Skill Level value '+opts.skill);
      engine.postMessage('setoption name Threads value 1');
      engine.postMessage('setoption name Hash value 16');
      engine.onmessage = (msg)=>{
        const text = (typeof msg==='object'&&msg?.data)? msg.data : String(msg);
        if (text.startsWith('bestmove')){
          const m = text.split(' ')[1];
          if (m && !game.isGameOver()){
            game.move({from:m.slice(0,2), to:m.slice(2,4), promotion:'q'});
            paintPieces(); setStatus();
          }
        }
      };
    } catch (e){
      engine = null;
      engineTag.textContent = 'ИИ: offline (random)';
      console.warn('Stockfish init failed; fallback to random AI', e);
    }
  }

  function aiMove(){
    if (game.isGameOver()) return;
    const opts = LEVELS[diffSel.value]||LEVELS.supergm;
    if (engine){
      engine.postMessage('position fen '+game.fen());
      engine.postMessage(`go movetime ${opts.movetime} depth ${opts.depth}`);
    } else {
      // офлайн-ИИ: случайный допустимый ход
      const moves = game.moves({verbose:true});
      if (!moves.length) return;
      const mv = moves[Math.floor(Math.random()*moves.length)];
      setTimeout(()=>{
        game.move({from:mv.from, to:mv.to, promotion:'q'});
        paintPieces(); setStatus();
      }, 250);
    }
  }

  let selected=null;
  function highlight(from){
    const legal = game.moves({square:from, verbose:true});
    const squares = boardEl.querySelectorAll('.sq');
    squares.forEach(s=>s.classList.remove('mv','cap'));
    for(const m of legal){
      const {r,c} = RCFromAlg(m.to);
      squares[r*8+c].classList.add(m.flags.includes('c')?'cap':'mv');
    }
  }
  function onSquareClick(e){
    const sq = e.currentTarget;
    const r = parseInt(sq.dataset.r,10);
    const c = parseInt(sq.dataset.c,10);
    const rr = flipped? 7-r : r;
    const cc = flipped? 7-c : c;
    const a = algebraicFromRC(rr,cc);
    const squares = boardEl.querySelectorAll('.sq');

    if (!selected){
      const piece = game.get(a);
      if (!piece || piece.color !== game.turn()) return;
      selected=a; squares.forEach(s=>s.classList.remove('sel','mv','cap'));
      sq.classList.add('sel'); highlight(selected);
    } else {
      const move = game.move({from:selected,to:a,promotion:'q'});
      if (move){
        selected=null; paintPieces(); setStatus();
        if (!game.isGameOver()) aiMove();
      } else {
        const piece = game.get(a);
        if (piece && piece.color===game.turn()){
          selected=a; squares.forEach(s=>s.classList.remove('sel','mv','cap'));
          sq.classList.add('sel'); highlight(selected);
        } else {
          selected=null; squares.forEach(s=>s.classList.remove('sel','mv','cap'));
        }
      }
    }
  }
  function attachClicks(){
    [...boardEl.querySelectorAll('.sq')].forEach(el=>el.addEventListener('click', onSquareClick));
  }

  function orient(color){
    flipped = (color==='b');
    boardEl.style.transform = flipped? 'rotate(180deg)' : 'none';
    [...boardEl.querySelectorAll('.sq')].forEach(el=> el.style.transform = flipped? 'rotate(180deg)' : 'none');
  }

  function freshBoard(){ renderBoard(); attachClicks(); }

  function startNewGame(){
    game = new Chess();
    freshBoard();            // 1) сначала рисуем доску
    paintPieces(); setStatus();
    setupEngine();           // 2) потом безопасно пытаемся включить ИИ
    orient(colorSel.value);  // 3) поворот после рендера
    if (colorSel.value==='b'){ aiMove(); } // ИИ ходит первым, если пользователь за чёрных
  }

  document.getElementById('newgame').addEventListener('click', startNewGame);
  document.getElementById('flip').addEventListener('click', ()=> orient(flipped?'w':'b'));

  // init
  startNewGame();
})();
</script>
</body>
</html>
