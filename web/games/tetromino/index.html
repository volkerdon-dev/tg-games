<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <title>Falling Blocks</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#0f0f12; --text:#fafafa; --hint:#9aa0a6; --card:#111827; --grid:#1f2937;
      --cI:#8dd3ff; --cJ:#8ea6ff; --cL:#ffc38d; --cO:#ffe78d;
      --cS:#9ff2b2; --cT:#d7a4ff; --cZ:#ff9fa3; --accent:#2ea6ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto}
    .wrap{max-width:900px;margin:0 auto;padding:14px}
    header{display:flex;align-items:center;gap:8px;margin-bottom:8px}
    .back{background:#0000;border:1px solid #2b2f36;color:var(--text);padding:8px 12px;border-radius:12px;text-decoration:none}
    h1{margin:0;font-size:18px;flex:1;text-align:center}
    .game{display:grid;grid-template-columns:1fr auto;gap:12px}
    .panel{background:var(--card);border-radius:16px;padding:12px;display:flex;flex-direction:column;gap:8px}
    .stats{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .stat{background:#121826;border:1px solid #202636;border-radius:12px;padding:8px}
    .stat b{display:block;font-size:12px;color:var(--hint)}
    .stat span{font-size:16px}
    canvas{background:var(--grid);border-radius:16px;touch-action:none;display:block}
    .controls{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:8px}
    .btn{border:none;border-radius:12px;padding:10px;font-size:14px;background:#1a2330;color:var(--text)}
    .btn.primary{background:var(--accent);color:#000}
    .overlay{
      position:fixed;inset:0;background:rgba(0,0,0,.6);
      display:none;align-items:center;justify-content:center;padding:16px
    }
    .card{background:var(--card);border:1px solid #202636;border-radius:16px;padding:16px;max-width:420px;width:100%;text-align:center}
    .card h2{margin:0 0 8px}
    .muted{color:var(--hint);font-size:13px}
    footer{margin-top:8px;color:var(--hint);font-size:12px;text-align:center}
    @media (max-width:720px){ .game{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <a class="back" href="../../index.html">← В меню игр</a>
      <h1>Falling Blocks</h1>
      <span style="width:88px"></span>
    </header>

    <div class="game">
      <div class="panel">
        <canvas id="board" width="300" height="600" aria-label="Игровое поле"></canvas>

        <div class="controls">
          <button class="btn" id="left">◀︎</button>
          <button class="btn" id="rot">⟳</button>
          <button class="btn" id="right">▶︎</button>
          <button class="btn primary" id="drop">⤓</button>
        </div>
      </div>

      <aside class="panel" aria-label="Панель">
        <div class="stats">
          <div class="stat"><b>Очки</b><span id="score">0</span></div>
          <div class="stat"><b>Линии</b><span id="lines">0</span></div>
          <div class="stat"><b>Уровень</b><span id="level">1</span></div>
          <div class="stat"><b>След.</b><span id="next" style="display:block;height:64px"></span></div>
        </div>
        <div style="display:flex;gap:8px;margin-top:4px">
          <button class="btn" id="pause">Пауза</button>
          <button class="btn" id="restart">Заново</button>
        </div>
        <p class="muted">Клавиши: ← → ↓, ↑ — поворот, Space — «Hard Drop», P — пауза.</p>
      </aside>
    </div>

    <footer>
      This is an independent falling blocks game. “Tetris” is a registered trademark of The Tetris Company, LLC.
    </footer>
  </div>

  <div class="overlay" id="overlay">
    <div class="card">
      <h2 id="ovTitle">Игра окончена</h2>
      <p class="muted" id="ovText"></p>
      <div style="display:flex;gap:8px;justify-content:center;margin-top:8px">
        <button class="btn" id="ovRestart">Играть снова</button>
        <a class="btn" href="../../index.html">← В меню</a>
      </div>
    </div>
  </div>

<script>
(() => {
  const tg = window.Telegram?.WebApp; tg?.ready(); tg?.expand();

  // --- Константы и состояние ---
  const COLS=10, ROWS=20, TILE=30;
  const COLORS={ I:'var(--cI)',J:'var(--cJ)',L:'var(--cL)',O:'var(--cO)',S:'var(--cS)',T:'var(--cT)',Z:'var(--cZ)' };
  const SHAPES={
    I:[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],
    J:[[1,0,0],[1,1,1],[0,0,0]],
    L:[[0,0,1],[1,1,1],[0,0,0]],
    O:[[1,1],[1,1]],
    S:[[0,1,1],[1,1,0],[0,0,0]],
    T:[[0,1,0],[1,1,1],[0,0,0]],
    Z:[[1,1,0],[0,1,1],[0,0,0]],
  };
  const canvas=document.getElementById('board');
  const ctx=canvas.getContext('2d');

  // Доска
  const board = Array.from({length:ROWS},()=>Array(COLS).fill(null));

  // UI
  const $score = document.getElementById('score');
  const $lines = document.getElementById('lines');
  const $level = document.getElementById('level');
  const $next  = document.getElementById('next');
  const $ov    = document.getElementById('overlay');
  const $ovTitle = document.getElementById('ovTitle');
  const $ovText  = document.getElementById('ovText');

  // Рандом-мешок 7 фигур
  let bag=[], nextPiece=null;
  function refillBag(){
    bag = Object.keys(SHAPES);
    for(let i=bag.length-1;i>0;i--){
      const j = (Math.random()* (i+1))|0; [bag[i],bag[j]]=[bag[j],bag[i]];
    }
  }
  function pullPiece(){
    if(!bag.length) refillBag();
    const t = bag.pop();
    return { type:t, shape:SHAPES[t].map(r=>r.slice()), x: Math.floor((COLS - SHAPES[t][0].length)/2), y:0 };
  }

  // Текущее состояние игры
  let piece, score, lines, level, fallInterval, lastTime=0, dropAcc=0, paused=false, over=false;

  function reset(){
    for(let r=0;r<ROWS;r++) board[r].fill(null);
    score=0; lines=0; level=1; fallInterval=800; paused=false; over=false;
    nextPiece = pullPiece();
    spawn();
    updatePanel();
    hideOverlay();
  }

  function spawn(){
    piece = nextPiece || pullPiece();
    nextPiece = pullPiece();
    piece.y = 0; piece.x = Math.floor((COLS - piece.shape[0].length)/2);
    if(collides(0,0,piece.shape)){ gameOver(); }
    drawNext();
  }

  function drawNext(){
    const c = document.createElement('canvas'); c.width=64; c.height=64;
    const cx=c.getContext('2d'); cx.fillStyle='transparent'; cx.clearRect(0,0,64,64);
    const sh = nextPiece.shape, size = Math.max(sh.length, sh[0].length);
    const s=14, off=((64 - size*s)/2)|0;
    cx.fillStyle = COLORS[nextPiece.type];
    for(let y=0;y<sh.length;y++) for(let x=0;x<sh[y].length;x++){
      if(sh[y][x]) drawSquare(cx,off+x*s,off+y*s,s-2);
    }
    $next.innerHTML=''; $next.appendChild(c);
  }

  function updatePanel(){
    $score.textContent=score;
    $lines.textContent=lines;
    $level.textContent=level;
  }

  function levelUp(){
    level++; fallInterval = Math.max(90, 800 - (level-1)*70);
  }

  // Рендер
  function drawSquare(c,x,y,size){
    c.fillRect(x,y,size,size);
    c.fillStyle='rgba(255,255,255,.1)'; c.fillRect(x,y,size,3); // простая подсветка
    c.fillStyle='rgba(0,0,0,.2)'; c.fillRect(x,y+size-3,size,3);
    c.fillStyle=ctx.fillStyle;
  }

  function drawBoard(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    // сетка
    ctx.strokeStyle='#0f1620';
    for(let r=0;r<=ROWS;r++){ ctx.beginPath(); ctx.moveTo(0,r*TILE); ctx.lineTo(COLS*TILE,r*TILE); ctx.stroke(); }
    for(let c=0;c<=COLS;c++){ ctx.beginPath(); ctx.moveTo(c*TILE,0); ctx.lineTo(c*TILE,ROWS*TILE); ctx.stroke(); }
    // заполненные клетки
    for(let y=0;y<ROWS;y++) for(let x=0;x<COLS;x++){
      const cell=board[y][x];
      if(cell){ ctx.fillStyle=COLORS[cell]; drawSquare(ctx,x*TILE+1,y*TILE+1,TILE-2); }
    }
    // падающая фигура
    if(piece){
      ctx.fillStyle=COLORS[piece.type];
      eachCell(piece.shape,(x,y)=>{ drawSquare(ctx,(piece.x+x)*TILE+1,(piece.y+y)*TILE+1,TILE-2); });
    }
  }

  // Утилиты
  function eachCell(shape,fn){
    for(let y=0;y<shape.length;y++) for(let x=0;x<shape[y].length;x++){
      if(shape[y][x]) fn(x,y);
    }
  }

  function collides(offX,offY,shape){
    let ok=true;
    eachCell(shape,(x,y)=>{
      const nx=piece.x + x + offX, ny=piece.y + y + offY;
      if(nx<0 || nx>=COLS || ny>=ROWS || (ny>=0 && board[ny][nx])) ok=false;
    });
    return !ok;
  }

  function merge(){
    eachCell(piece.shape,(x,y)=>{
      const nx=piece.x+x, ny=piece.y+y;
      if(ny>=0) board[ny][nx]=piece.type;
    });
  }

  function rotate(shape){
    const N=shape.length, M=shape[0].length;
    const res=Array.from({length:M},()=>Array(N).fill(0));
    for(let y=0;y<N;y++) for(let x=0;x<M;x++) res[x][N-1-y]=shape[y][x];
    return res;
  }

  function tryRotate(){
    const r = rotate(piece.shape);
    // простые wall-kicks
    const kicks = [0,-1,1,-2,2];
    for(const k of kicks){
      if(!collides(k,0,r)){ piece.shape=r; piece.x += k; return; }
    }
  }

  function clearLines(){
    let cleared=0;
    for(let y=ROWS-1;y>=0;){
      if(board[y].every(v=>!!v)){
        board.splice(y,1); board.unshift(Array(COLS).fill(null));
        cleared++; continue;
      }
      y--;
    }
    if(cleared){
      const pts = [0,100,300,500,800][cleared] || (800 + (cleared-4)*300);
      score += pts * level; lines += cleared;
      if(lines >= level*10) levelUp();
      updatePanel();
    }
  }

  function hardDrop(){
    while(!collides(0,1,piece.shape)) piece.y++;
    tick(true);
  }

  function softDrop(){ if(!collides(0,1,piece.shape)) piece.y++; else tick(true); }

  function move(dir){ if(!collides(dir,0,piece.shape)) piece.x += dir; }

  function tick(lock=false){
    if(!lock && !collides(0,1,piece.shape)){ piece.y++; return; }
    merge();
    clearLines();
    spawn();
  }

  function gameOver(){
    over=true; showOverlay('Игра окончена', `Очки: ${score} • Линии: ${lines} • Уровень: ${level}`);
  }

  // Цикл
  function loop(ts){
    if(paused || over){ drawBoard(); return requestAnimationFrame(loop); }
    const dt = ts - lastTime; lastTime = ts; dropAcc += dt;
    if(dropAcc >= fallInterval){ dropAcc=0; tick(false); }
    drawBoard();
    requestAnimationFrame(loop);
  }

  // События ввода
  window.addEventListener('keydown',e=>{
    if(over) return;
    if(e.code==='ArrowLeft') move(-1);
    else if(e.code==='ArrowRight') move(1);
    else if(e.code==='ArrowUp') tryRotate();
    else if(e.code==='ArrowDown') softDrop();
    else if(e.code==='Space') hardDrop();
    else if(e.code==='KeyP') togglePause();
    e.preventDefault();
  }, {passive:false});

  // Кнопки
  document.getElementById('left').onclick = ()=>move(-1);
  document.getElementById('right').onclick= ()=>move(1);
  document.getElementById('rot').onclick  = ()=>tryRotate();
  document.getElementById('drop').onclick = ()=>hardDrop();
  document.getElementById('restart').onclick = ()=>reset();
  document.getElementById('pause').onclick   = ()=>togglePause();
  document.getElementById('ovRestart').onclick = ()=>{ reset(); };

  // Telegram: запрет скролла
  ['touchmove','wheel'].forEach(ev=>document.addEventListener(ev,e=>e.preventDefault(),{passive:false}));

  function togglePause(){
    if(over) return;
    paused = !paused;
    if(paused) showOverlay('Пауза','Нажми «Играть снова» или «Пауза», чтобы продолжить.');
    else hideOverlay();
  }

  function showOverlay(title,text){
    document.getElementById('ovTitle').textContent=title;
    document.getElementById('ovText').textContent=text||'';
    $ov.style.display='flex';
  }
  function hideOverlay(){ $ov.style.display='none'; }

  // Старт
  reset();
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
