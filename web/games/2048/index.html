<!doctype html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>2048</title>
<style>
  :root{
    --board:#bbada0;         /* —Ä–∞–º–∫–∞/—Ñ–æ–Ω –¥–æ—Å–∫–∏ */
    --cell:#eee4da66;        /* –ë–ï–ñ–ï–í–´–ï –ø—É—Å—Ç—ã–µ –∫–ª–µ—Ç–∫–∏ */
    --text:#111827;
    --muted:#6b7280;
  }
  html,body{
    margin:0;padding:0;background:#fff;color:var(--text);
    font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
    overscroll-behavior: none; /* –º–µ–Ω—å—à–µ "—Ä—ã–≤–∫–æ–≤" –Ω–∞ iOS */
  }
  .wrap{max-width:760px;margin:0 auto;padding:16px;position:relative;}
  h1{font-size:28px;font-weight:800;display:flex;gap:8px;align-items:center;margin:0 0 8px;}
  .topbar{display:flex;justify-content:space-between;gap:12px;align-items:center;flex-wrap:wrap}
  .left{display:flex;gap:10px;align-items:center}
  .btn{padding:8px 14px;border-radius:14px;border:1px solid #e5e7eb;background:#f3f4f6;cursor:pointer}
  .btn:active{transform:scale(.98)}
  .btn.dark,.btn.primary{background:#111827;color:#f9fafb;border-color:#111827}
  .badge{border:1px solid #e5e7eb;border-radius:12px;padding:6px 10px;background:#fff}
  .muted{color:var(--muted)}
  .board{
    margin-top:12px;background:var(--board);border-radius:20px;padding:12px;
    display:grid;grid-template-columns:repeat(4,1fr);gap:12px;
    touch-action:none; user-select:none; -webkit-user-select:none; /* –æ—Ç–∫–ª—é—á–∞–µ–º –Ω–∞—Ç–∏–≤–Ω—É—é –ø—Ä–æ–∫—Ä—É—Ç–∫—É */
  }
  .cell{
    aspect-ratio:1/1;border-radius:12px;background:var(--cell);
    display:flex;align-items:center;justify-content:center;
    color:#fff;font-size:26px;font-weight:800;
    box-shadow: inset 0 0 0 1px #a39387;
  }
  .tile{
    width:100%;height:100%;display:flex;align-items:center;justify-content:center;
    border-radius:12px;font-weight:800;
    box-shadow: inset 0 -3px 0 rgba(0,0,0,.08);
  }
  /* –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –ø–∞–ª–∏—Ç—Ä–∞ 2048 */
  .n2   {background:#eee4da;color:#776e65}
  .n4   {background:#ede0c8;color:#776e65}
  .n8   {background:#f2b179;color:#f9f9f9}
  .n16  {background:#f59563;color:#fff}
  .n32  {background:#f67c5f;color:#fff}
  .n64  {background:#f65e3b;color:#fff}
  .n128 {background:#edcf72;color:#fff}
  .n256 {background:#edcc61;color:#fff}
  .n512 {background:#edc850;color:#fff}
  .n1024{background:#edc53f;color:#fff;font-size:22px}
  .n2048{background:#edc22e;color:#fff;font-size:22px}

  .status{margin-top:10px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}

  /* Game Over overlay */
  .overlay{position:fixed;inset:0;background:rgba(17,24,39,.55);backdrop-filter:blur(2px);
    display:none;align-items:center;justify-content:center;z-index:5}
  .toast{background:#fff;color:#111827;border-radius:16px;padding:18px 18px 14px;
    box-shadow:0 10px 30px rgba(0,0,0,.35);text-align:center;min-width:260px;animation:pop .18s ease-out}
  .toast h3{margin:0 0 8px;font-size:20px}
  .toast p{margin:0 0 12px}
  @keyframes pop{from{transform:scale(.96);opacity:.6}to{transform:scale(1);opacity:1}}
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="left">
      <button class="btn" id="backBtn">‚Üê –í –º–µ–Ω—é –∏–≥—Ä</button>
      <h1>2048</h1>
    </div>
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <span class="badge">–°—á—ë—Ç: <b id="score">0</b></span>
      <span class="badge">–†–µ–∫–æ—Ä–¥: <b id="best">0</b></span>
      <button class="btn dark" id="newBtn">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
    </div>
  </div>

  <div class="status">
    <span class="muted">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: —Å—Ç—Ä–µ–ª–∫–∏ / WASD / —Å–≤–∞–π–ø—ã</span>
  </div>

  <div class="board" id="board"></div>

  <div class="overlay" id="overlay">
    <div class="toast">
      <h3 id="ovTitle">–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞</h3>
      <p id="ovText">–ù–µ—Ç —Ö–æ–¥–æ–≤...</p>
      <div style="display:flex;gap:8px;justify-content:center">
        <button class="btn primary" id="againBtn">–°—ã–≥—Ä–∞—Ç—å –µ—â—ë</button>
        <button class="btn" id="closeBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <p class="muted" style="margin-top:8px;font-size:12px">
        –û—Å–Ω–æ–≤–∞–Ω–æ –Ω–∞ 2048 (¬© 2014 Gabriele Cirulli, MIT)
      </p>
    </div>
  </div>
</div>

<script>
  const N = 4;
  const boardEl = document.getElementById('board');
  const scoreEl = document.getElementById('score');
  const bestEl  = document.getElementById('best');
  const overlay = document.getElementById('overlay');
  const ovTitle = document.getElementById('ovTitle');
  const ovText  = document.getElementById('ovText');
  const againBtn= document.getElementById('againBtn');
  const closeBtn= document.getElementById('closeBtn');
  const newBtn  = document.getElementById('newBtn');
  const backBtn = document.getElementById('backBtn');

  let grid = [];
  let score = 0;
  let best  = +localStorage.getItem('best2048') || 0;

  function resetGrid(){ grid = Array.from({length:N},()=>Array(N).fill(0)); }
  function emptyCells(){ const a=[]; for(let r=0;r<N;r++) for(let c=0;c<N;c++) if(!grid[r][c]) a.push([r,c]); return a; }
  function spawn(){
    const cells=emptyCells(); if(!cells.length) return;
    const [r,c]=cells[Math.floor(Math.random()*cells.length)];
    grid[r][c] = Math.random()<0.9?2:4;
  }
  function updateScore(delta){
    score += delta; scoreEl.textContent = score;
    if(score>best){ best=score; bestEl.textContent=best; localStorage.setItem('best2048', best); }
  }
  function draw(){
    boardEl.innerHTML='';
    for(let r=0;r<N;r++){
      for(let c=0;c<N;c++){
        const v=grid[r][c];
        const cell=document.createElement('div'); cell.className='cell';
        if(v){
          const tile=document.createElement('div'); tile.className='tile n'+v;
          tile.textContent=v; tile.style.fontSize = v>=1024 ? '22px' : '26px';
          cell.appendChild(tile);
        }
        boardEl.appendChild(cell);
      }
    }
  }

  function slide(row){ const arr=row.filter(v=>v!==0); while(arr.length<N) arr.push(0); return arr; }
  function combine(row){
    let gained=0;
    for(let i=0;i<N-1;i++) if(row[i]&&row[i]===row[i+1]){ row[i]*=2; row[i+1]=0; gained+=row[i]; }
    return {row,gained};
  }

  function moveLeft(){
    let moved=false, gained=0;
    for(let r=0;r<N;r++){
      let row=slide(grid[r].slice());
      const res=combine(row); gained+=res.gained;
      row=slide(res.row);
      if(row.join(',')!==grid[r].join(',')){ moved=true; grid[r]=row; }
    }
    if(moved){ updateScore(gained); spawn(); draw(); checkEnd(); }
  }
  function rotateCW(){ const g=Array.from({length:N},()=>Array(N).fill(0));
    for(let r=0;r<N;r++) for(let c=0;c<N;c++) g[c][N-1-r]=grid[r][c]; grid=g; }
  function rotateCCW(){ const g=Array.from({length:N},()=>Array(N).fill(0));
    for(let r=0;r<N;r++) for(let c=0;c<N;c++) g[N-1-c][r]=grid[r][c]; grid=g; }
  function rotate180(){ rotateCW(); rotateCW(); }
  function moveRight(){ rotate180(); moveLeft(); rotate180(); }
  function moveUp(){ rotateCCW(); moveLeft(); rotateCW(); }
  function moveDown(){ rotateCW(); moveLeft(); rotateCCW(); }

  function hasMoves(){
    if(emptyCells().length) return true;
    for(let r=0;r<N;r++) for(let c=0;c<N-1;c++) if(grid[r][c]===grid[r][c+1]) return true;
    for(let c=0;c<N;c++) for(let r=0;r<N-1;r++) if(grid[r][c]===grid[r+1][c]) return true;
    return false;
  }
  function has2048(){ for(let r=0;r<N;r++) for(let c=0;c<N;c++) if(grid[r][c]===2048) return true; return false; }
  function checkEnd(){
    if(has2048()){ ovTitle.textContent='–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!'; ovText.textContent='–í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ 2048 üéâ'; overlay.style.display='flex'; return; }
    if(!hasMoves()){ ovTitle.textContent='–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞'; ovText.textContent='–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ö–æ–¥–æ–≤'; overlay.style.display='flex'; }
  }

  // --- —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–±–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É) ---
  window.addEventListener('keydown',(e)=>{
    const k=e.key;
    if(['ArrowLeft','ArrowRight','ArrowUp','ArrowDown'].includes(k)) e.preventDefault(); // –Ω–µ —Å–∫—Ä–æ–ª–ª–∏–º WebView
    const s=k.toLowerCase();
    if(s==='arrowleft'||s==='a') moveLeft();
    else if(s==='arrowright'||s==='d') moveRight();
    else if(s==='arrowup'||s==='w') moveUp();
    else if(s==='arrowdown'||s==='s') moveDown();
  });

  let sx=0, sy=0, touching=false;
  boardEl.addEventListener('touchstart',(e)=>{ const t=e.touches[0]; sx=t.clientX; sy=t.clientY; touching=true; }, {passive:false});
  boardEl.addEventListener('touchmove', (e)=>{ if(touching) e.preventDefault(); }, {passive:false});  // –≥–∞—Å–∏–º —Å–∫—Ä–æ–ª–ª Telegram WebApp
  boardEl.addEventListener('touchend',(e)=>{
    touching=false;
    const t=e.changedTouches[0]; const dx=t.clientX-sx, dy=t.clientY-sy;
    const ax=Math.abs(dx), ay=Math.abs(dy);
    if(ax<20 && ay<20) return;
    if(ax>ay){ dx>0 ? moveRight() : moveLeft(); } else { dy>0 ? moveDown() : moveUp(); }
  }, {passive:false});

  // buttons
  againBtn.onclick = ()=>{ overlay.style.display='none'; start(); };
  closeBtn.onclick = ()=>{ overlay.style.display='none'; };
  newBtn.onclick   = ()=> start();
  backBtn.onclick  = ()=> { window.location.href = '/'; };

  function start(){
    score=0; scoreEl.textContent=score; bestEl.textContent=best;
    resetGrid(); spawn(); spawn(); draw();
  }
  start();

  // ¬© 2014 Gabriele Cirulli ‚Äî MIT (–æ—Ä–∏–≥–∏–Ω–∞–ª). –≠—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞–ø–∏—Å–∞–Ω–∞ —Å –Ω—É–ª—è –∏ —Å–æ–≤–º–µ—Å—Ç–∏–º–∞ —Å MIT.
</script>
</body>
</html>
